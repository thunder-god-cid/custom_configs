// AJAX load vm listing
// Only necessary until Foreman 1.10.2 is released and implemented.
// This allows for EC2 security groups to be populated when
// provisioning a new host.
// The file should be kept in /usr/share/foreman/public/assets

function providerSelected(e){compute_connection=$("#compute_connection");var t=$(e).val();if(t=="")return compute_connection.hide(),$("[type=submit]").attr("disabled",!0),!1;$("[type=submit]").attr("disabled",!1);var n=$(e).attr("data-url"),r="provider="+t;compute_connection.show(),compute_connection.load(n+" div#compute_connection",r,function(){password_caps_lock_hint()})}function testConnection(e){var t=$("form").data("id"),n=$("input#compute_resource_password").val();$(".tab-error").removeClass("tab-error"),$("#test_connection_indicator").show(),$.ajax({type:"put",url:$(e).attr("data-url"),data:$("form").serialize()+"&cr_id="+t,success:function(e){var t=$("<div>"+e+"</div>");$("#compute_connection").html(t.find("#compute_connection")),$("#compute_connection").prepend(t.find(".alert"))},complete:function(e){$("input#compute_resource_password").val(n),reloadOnAjaxComplete("#test_connection_indicator")}})}function ovirt_templateSelected(e){var t=$(e).val();if(t){var n=$(e).attr("data-url");$(e).indicator_show(),$.ajax({type:"post",url:n,data:"template_id="+t,success:function(e){$("[id$=_memory]").val(e.memory),$("[id$=_cores]").val(e.cores),$("#network_interfaces").children(".fields").remove(),$.each(e.interfaces,function(){add_network_interface(this)}),$("#volumes").children(".fields").remove(),$.each(e.volumes,function(){add_volume(this)})},complete:function(){reloadOnAjaxComplete(e)}})}}function add_network_interface(e){var t=add_child_node($("#network_interfaces .add_nested_fields"));$("[id$="+t+"_name]").val(e.name),$("[id$="+t+"_network]").val(e.network)}function add_volume(e){var t=add_child_node($("#volumes .add_nested_fields"));disable_element($("[id$="+t+"_size_gb]").val(e.size_gb)),disable_element($("[id$="+t+"_storage_domain]").val(e.storage_domain)),disable_element($("[id$="+t+"_bootable_true]").attr("checked",e.bootable)),$("[id$="+t+"_id]").val(7),$("[id$="+t+"_storage_domain]").next().hide()}function disable_element(e){e.clone().attr("type","hidden").appendTo(e),e.attr("disabled","disabled")}function bootable_radio(e){var t=$("[id$=_bootable_true]:disabled:checked:visible");$("[id$=_bootable_true]").attr("checked",!1),t.length>0?t.attr("checked",!0):$(e).attr("checked",!0)}function ovirt_clusterSelected(e){var t=$(e).val(),n=$(e).attr("data-url");$(e).indicator_show(),$.ajax({type:"post",url:n,data:"cluster_id="+t,success:function(e){var t=$("select[id$=_network]").empty();$.each(e,function(){t.append($("<option />").val(this.id).text(this.name))})},complete:function(){reloadOnAjaxComplete(e)}})}function ovirt_datacenterSelected(e){testConnection($("#test_connection_button"))}function libvirt_network_selected(e){selected=$(e).val(),dropdown=$(e).closest("select"),bridge=$(e).parentsUntil(".fields").parent().find("#bridge"),nat=$(e).parentsUntil(".fields").parent().find("#nat");switch(selected){case"":disable_libvirt_dropdown(bridge),disable_libvirt_dropdown(nat);break;case"network":disable_libvirt_dropdown(bridge),enable_libvirt_dropdown(nat);break;case"bridge":disable_libvirt_dropdown(nat),enable_libvirt_dropdown(bridge)}return!1}function disable_libvirt_dropdown(e){e.hide(),e.attr("disabled",!0)}function enable_libvirt_dropdown(e){e.attr("disabled",!1),e.find(":input").attr("disabled",!1),e.show()}function libvirt_image_selected(e){var t=$(e).val();if(t){var n=$(e).attr("data-url");$(e).indicator_show(),$.ajax({type:"post",url:n,data:"template_id="+t,success:function(e){capacity=$("#storage_volumes").children(".fields").find("[id$=capacity]")[0],parseInt(capacity.value.slice(0,-1),10)<parseInt(e.capacity,10)&&(capacity.value=e.capacity+"G"),$("#storage_volumes").children(".fields").find("[id$=format_type]")[0].value="qcow2"},complete:function(){reloadOnAjaxComplete(e)}})}}function ec2_vpcSelected(e){sg_select=$("select.security_group_ids"),sg_select.empty(),security_groups=jQuery.parseJSON(sg_select.attr("data-security-groups")),subnets=jQuery.parseJSON(sg_select.attr("data-subnets")),e.value!=""?vpc=subnets[e.value]:vpc={vpc_id:"ec2",subnet_name:"ec2"};for(sg in security_groups[vpc.vpc_id])sg_select.append($("<option />").val(security_groups[vpc.vpc_id][sg].group_id).text(security_groups[vpc.vpc_id][sg].group_name+" - "+vpc.subnet_name));sg_select.multiSelect("refresh")}function capacity_edit(e){var t=$(e).closest(".fields").find("button[name=allocation_radio_btn].btn.active");if(t.length>0&&$(t[0]).text()=="Full"){var n=$(e).closest(".fields").find("[id$=allocation]")[0];n.value=e.value}return!1}function allocation_switcher(e,t){var n=$(e).parent().find(".active");n.removeClass("active");var r=$(e).closest(".fields").find("[id$=allocation]")[0];if(t=="None")$(r).attr("readonly","readonly"),r.value="0G";else if(t=="Size")$(r).removeAttr("readonly"),r.value="",$(r).focus();else if(t=="Full"){$(r).attr("readonly","readonly");var i=$(e).closest(".fields").find("[id$=capacity]")[0];r.value=i.value}return $(e).button("toggle"),!1}$(function(){$("#vms, #images_list").each(function(){var e=$(this).attr("data-url");$(this).load(e+" table",function(e,t,n){t=="error"&&$(this).closest(".tab-content").find("#spinner").html(Jed.sprintf(__("There was an error listing VMs: %(status)s %(statusText)s"),{status:n.status,statusText:n.statusText})),$(".dropdown-toggle").dropdown(),$(document.body).trigger("ContentLoad")})})});
